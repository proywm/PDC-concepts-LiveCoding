import numpy as np
import matplotlib.pyplot as plt
from matplotlib.animation import FuncAnimation
import ipywidgets as widgets
from IPython.display import display, clear_output, HTML
# Function to update the plot for each frame of the animation
def update_plot(ax, array, requests, shelf_texts, table_texts, shelf_boxes, table_boxes, miss_rate_text, miss_rate, current_index=None, action_text=None, updated_index=None, removed_index=None):
    for text, box in zip(shelf_texts, shelf_boxes):
        box.set_edgecolor('b')  # Reset color to blue
        text.set_color('black')
    for text, box in zip(table_texts, table_boxes):
        box.set_edgecolor('gray')  # Reset color to gray
        text.set_text('')  # Clear text
    for i, book in enumerate(requests):
        table_texts[i].set_text(book)
        table_boxes[i].set_edgecolor('b')
    if current_index is not None:
        shelf_boxes[current_index].set_edgecolor('r')
        shelf_texts[current_index].set_color('red')
    if updated_index is not None:
        table_boxes[updated_index].set_edgecolor('green')  # Mark updated index with green
    if removed_index is not None:
        table_boxes[removed_index].set_edgecolor('red')  # Mark removed index with red
    if action_text:
        ax.set_title(action_text, fontsize=16)
    miss_rate_text.set_text(f"Miss Rate: {miss_rate:.2f}")
    plt.draw()
# Function to handle the book requests and yield control after each action
def handle_requests(ax, array, requests, table, max_table_size):
    hits, misses = 0, 0
    actions = []
    for book in requests:
        updated_index = None
        removed_index = None
        if book in table:
            hits += 1
            actions.append((array, table, requests, None, f"Book {book} is already on the table", hits, misses, updated_index, removed_index))
        else:
            misses += 1
            if len(table) < max_table_size:
                table.append(book)
                updated_index = len(table) - 1
                actions.append((array, table, requests, list(array).index(book), f"Fetched book {book} from shelf to table", hits, misses, updated_index, removed_index))
            else:
                evicted_book = table.pop(0)
                removed_index = 0
                table.append(book)
                updated_index = len(table) - 1
                actions.append((array, table, requests, list(array).index(book), f"Evicted book {evicted_book} from table to shelf, fetched book {book}", hits, misses, updated_index, removed_index))
        miss_rate = misses / (hits + misses)
        yield array, table, requests, list(array).index(book) if book not in table else None, actions[-1][4], miss_rate, updated_index, removed_index
    yield array, table, requests, None, "All requests processed", misses / (hits + misses), None, None
# Function to visualize the fetching process
def visualize_fetching(array, requests):
    fig, ax = plt.subplots(figsize=(10, 6))
    ax.set_xlim(-1, max(len(array), 3) + 1)
    ax.set_ylim(-3, 3)
    ax.axis('off')
    shelf_texts = []
    table_texts = []
    shelf_boxes = []
    table_boxes = []
    # Add Bookshelf label
    ax.text(-1, 0.5, 'Bookshelf', ha='center', va='center', fontsize=14, fontweight='bold')
    for i, num in enumerate(array):
        shelf_text = ax.text(i + 0.5, 0.5, str(num), ha='center', va='center', fontsize=12, bbox=dict(facecolor='white', edgecolor='b'))
        shelf_box = plt.Rectangle((i, 0), 1, 1, fill=None, edgecolor='b')
        ax.add_patch(shelf_box)
        shelf_texts.append(shelf_text)
        shelf_boxes.append(shelf_box)
    # Add Table label
    ax.text(-0.5, -1.5, 'Table', ha='center', va='center', fontsize=14, fontweight='bold')
    for i in range(3):
        table_text = ax.text(i + 0.5, -1.5, "", ha='center', va='center', fontsize=12, bbox=dict(facecolor='white', edgecolor='gray'))
        table_box = plt.Rectangle((i, -2), 1, 1, fill=None, edgecolor='gray')
        ax.add_patch(table_box)
        table_texts.append(table_text)
        table_boxes.append(table_box)
    # Add Miss Rate label
    miss_rate_text = ax.text(-1, 2, 'Miss Rate: 0.00', ha='center', va='center', fontsize=14, fontweight='bold')
    table = []
    max_table_size = 3
    def animate(data):
        array, table, requests, current_index, action_text, miss_rate, updated_index, removed_index = data
        update_plot(ax, array, table, shelf_texts, table_texts, shelf_boxes, table_boxes, miss_rate_text, miss_rate, current_index, action_text, updated_index, removed_index)
    ani = FuncAnimation(fig, animate, frames=handle_requests(ax, array, requests, table, max_table_size), interval=1000, repeat=False)
    plt.close(fig)
    return ani
# Function to handle the button click event
def on_button_click(b):
    clear_output(wait=True)
    array = np.random.randint(1, 100, size=10)
    requests = list(np.random.choice(array, size=5, replace=True))
    print("Book requests over time:", requests)
    ani = visualize_fetching(array, requests)
    display(HTML(ani.to_jshtml()))
    print("Books on shelf:", array)
# Create a button to trigger the visualization
button = widgets.Button(description="Visualize Fetching")
button.on_click(on_button_click)
display(button)
